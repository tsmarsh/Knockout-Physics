var Attraction,Behaviour,Collision,ConstantForce,EdgeBounce,EdgeWrap,Euler,ImprovedEuler,Integrator,Particle,Physics,Random,Spring,Vector,Verlet,Wander,namespace,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};namespace=function(e){var t,n,r,i,s,o,u;n=self,s=e.split("."),u=[];for(r=0,i=s.length;r<i;r++)t=s[r],u.push(n=(o=n[t])!=null?o:n[t]={});return u},function(){var e,t,n,r,i;e=0,n=["ms","moz","webkit","o"];for(r=0,i=n.length;r<i;r++){t=n[r];if(!!window.requestAnimationFrame)continue;window.requestAnimationFrame=window[t+"RequestAnimationFrame"],window.cancelRequestAnimationFrame=window[t+"CancelRequestAnimationFrame"]}window.requestAnimationFrame||(window.requestAnimationFrame=function(t,n){var r,i,s;return i=(new Date).getTime(),r=Math.max(0,16-(i-s)),setTimeout(function(){return t(e+r)},r),s=i+r});if(!window.cancelAnimationFrame)return window.cancelAnimationFrame=function(e){return clearTimeout(e)}}(),Random=function(e,t){return t==null&&(t=e,e=0),e+Math.random()*(t-e)},Random.int=function(e,t){return t==null&&(t=e,e=0),Math.floor(e+Math.random()*(t-e))},Random.sign=function(e){return e==null&&(e=.5),Math.random()<e?1:-1},Random.bool=function(e){return e==null&&(e=.5),Math.random()<e},Random.item=function(e){return e[Math.floor(Math.random()*e.length)]},Vector=function(){function e(e,t){this.x=e!=null?e:0,this.y=t!=null?t:0}return e.name="Vector",e.add=function(t,n){return new e(t.x+n.x,t.y+n.y)},e.sub=function(t,n){return new e(t.x-n.x,t.y-n.y)},e.project=function(e,t){return e.clone().scale(e.dot(t)/e.magSq())},e.prototype.set=function(e,t){return this.x=e,this.y=t,this},e.prototype.add=function(e){return this.x+=e.x,this.y+=e.y,this},e.prototype.sub=function(e){return this.x-=e.x,this.y-=e.y,this},e.prototype.scale=function(e){return this.x*=e,this.y*=e,this},e.prototype.dot=function(e){return this.x*e.x+this.y*e.y},e.prototype.cross=function(e){return this.x*e.y-this.y*e.x},e.prototype.mag=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},e.prototype.magSq=function(){return this.x*this.x+this.y*this.y},e.prototype.dist=function(e){var t,n;return t=e.x-this.x,n=e.y-this.y,Math.sqrt(t*t+n*n)},e.prototype.distSq=function(e){var t,n;return t=e.x-this.x,n=e.y-this.y,t*t+n*n},e.prototype.norm=function(){var e;return e=Math.sqrt(this.x*this.x+this.y*this.y),this.x/=e,this.y/=e,this},e.prototype.limit=function(e){var t,n;n=this.x*this.x+this.y*this.y;if(n>e*e)return t=Math.sqrt(n),this.x/=t,this.y/=t,this.x*=e,this.y*=e,this},e.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this},e.prototype.clone=function(){return new e(this.x,this.y)},e.prototype.clear=function(){return this.x=0,this.y=0,this},e}(),Particle=function(){function e(t){this.mass=t!=null?t:1,this.id="p"+e.GUID++,this.setMass(this.mass),this.setRadius(1),this.fixed=!1,this.behaviours=[],this.pos=new Vector,this.x=ko.observable(this.pos.x),this.y=ko.observable(this.pos.y),this.vel=new Vector,this.acc=new Vector,this.old={pos:new Vector,vel:new Vector,acc:new Vector}}return e.name="Particle",e.GUID=0,e.prototype.moveTo=function(e){return this.pos.copy(e),this.old.pos.copy(e)},e.prototype.setMass=function(e){return this.mass=e!=null?e:1,this.massInv=1/this.mass},e.prototype.setRadius=function(e){return this.radius=e!=null?e:1,this.radiusSq=this.radius*this.radius},e.prototype.update=function(e,t){var n,r,i,s,o;if(!this.fixed){s=this.behaviours,o=[];for(r=0,i=s.length;r<i;r++)n=s[r],o.push(n.apply(this,e,t));return o}},e}(),Spring=function(){function e(e,t,n,r){this.p1=e,this.p2=t,this.restLength=n!=null?n:100,this.stiffness=r!=null?r:1,this._delta=new Vector}return e.name="Spring",e.prototype.apply=function(){var e,t;this._delta.copy(this.p2.pos).sub(this.p1.pos),e=this._delta.mag()+1e-6,t=(e-this.restLength)/(e*(this.p1.massInv+this.p2.massInv))*this.stiffness,this.p1.fixed||this.p1.pos.add(this._delta.clone().scale(t*this.p1.massInv));if(!this.p2.fixed)return this.p2.pos.add(this._delta.scale(-t*this.p2.massInv))},e}(),Physics=function(){function e(e){this.integrator=e!=null?e:new Euler,this.timestep=1/60,this.viscosity=.005,this.behaviours=[],this._time=0,this._step=0,this._clock=null,this._buffer=0,this._maxSteps=4,this.particles=[],this.springs=[]}return e.name="Physics",e.prototype.integrate=function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p,d,v;n=1-this.viscosity,h=this.particles;for(r=o=0,f=h.length;o<f;r=++o){i=h[r],p=this.behaviours;for(u=0,l=p.length;u<l;u++)t=p[u],t.apply(i,e,r);i.update(e,r)}this.integrator.integrate(this.particles,e,n),d=this.springs,v=[];for(a=0,c=d.length;a<c;a++)s=d[a],v.push(s.apply());return v},e.prototype.step=function(){var e,t,n;this._clock==null&&(this._clock=(new Date).getTime()),n=(new Date).getTime(),e=n-this._clock;if(e<=0)return;e*=.001,this._clock=n,this._buffer+=e,t=0;while(this._buffer>=this.timestep&&++t<this._maxSteps)this.integrate(this.timestep),this._buffer-=this.timestep,this._time+=this.timestep;return this._step=(new Date).getTime()-n},e.prototype.destroy=function(){return this.integrator=null,this.particles=null,this.springs=null},e}(),Integrator=function(){function e(){}return e.name="Integrator",e.prototype.integrate=function(e,t){},e}(),Euler=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.name="Euler",t.prototype.integrate=function(e,t,n){var r,i,s,o,u;i=new Vector,u=[];for(s=0,o=e.length;s<o;s++){r=e[s];if(!!r.fixed)continue;r.old.pos.copy(r.pos),r.acc.scale(r.massInv),i.copy(r.vel),r.vel.add(r.acc.scale(t)),r.pos.add(i.scale(t)),n&&r.vel.scale(n),u.push(r.acc.clear())}return u},t}(Integrator),ImprovedEuler=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.name="ImprovedEuler",t.prototype.integrate=function(e,t,n){var r,i,s,o,u,a,f;r=new Vector,o=new Vector,i=t*t,f=[];for(u=0,a=e.length;u<a;u++){s=e[u];if(!!s.fixed)continue;s.old.pos.copy(s.pos),s.acc.scale(s.massInv),o.copy(s.vel),r.copy(s.acc),s.pos.add(o.scale(t).add(r.scale(.5*i))),s.vel.add(s.acc.scale(t)),n&&s.vel.scale(n),f.push(s.acc.clear())}return f},t}(Integrator),Verlet=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.name="Verlet",t.prototype.integrate=function(e,t,n){var r,i,s,o,u,a;s=new Vector,r=t*t,a=[];for(o=0,u=e.length;o<u;o++){i=e[o];if(!!i.fixed)continue;i.acc.scale(i.massInv),i.vel.copy(i.pos).sub(i.old.pos),n&&i.vel.scale(n),s.copy(i.pos).add(i.vel.add(i.acc.scale(r))),i.old.pos.copy(i.pos),i.pos.copy(s),a.push(i.acc.clear())}return a},t}(Integrator),Behaviour=function(){function e(){this.GUID=e.GUID++,this.interval=1}return e.name="Behaviour",e.GUID=0,e.prototype.apply=function(e,t,n){var r,i;return((i=e[r="__behaviour"+this.GUID])!=null?i:e[r]={counter:0}).counter++},e}(),Attraction=function(e){function t(e,n,r){this.target=e!=null?e:new Vector,this.radius=n!=null?n:1e3,this.strength=r!=null?r:100,this._delta=new Vector,this.setRadius(this.radius),t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.name="Attraction",t.prototype.setRadius=function(e){return this.radius=e,this.radiusSq=e*e},t.prototype.apply=function(e,t,n){var r;this._delta.copy(this.target).sub(e.pos),r=this._delta.magSq();if(r<this.radiusSq&&r>1e-6)return this._delta.norm().scale(1-r/this.radiusSq),e.acc.add(this._delta.scale(this.strength))},t}(Behaviour),Collision=function(e){function t(e,n){this.useMass=e!=null?e:!0,this.callback=n!=null?n:null,this.pool=[],this._delta=new Vector,t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.name="Collision",t.prototype.apply=function(e,t,n){var r,i,s,o,u,a,f,l,c,h,p,d;d=[];for(s=h=n,p=this.pool.length-1;n<=p?h<=p:h>=p;s=n<=p?++h:--h)u=this.pool[s],u!==e?(this._delta.copy(u.pos).sub(e.pos),i=this._delta.magSq(),c=e.radius+u.radius,i<=c*c?(r=Math.sqrt(i),a=e.radius+u.radius-r,a+=.5,o=e.mass+u.mass,f=this.useMass?u.mass/o:.5,l=this.useMass?e.mass/o:.5,e.pos.add(this._delta.clone().norm().scale(a*-f)),u.pos.add(this._delta.norm().scale(a*l)),d.push(typeof this.callback=="function"?this.callback(e,u,a):void 0)):d.push(void 0)):d.push(void 0);return d},t}(Behaviour),ConstantForce=function(e){function t(e){this.force=e!=null?e:new Vector,t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.name="ConstantForce",t.prototype.apply=function(e,t,n){return e.acc.add(this.force)},t}(Behaviour),EdgeBounce=function(e){function t(e,n){this.min=e!=null?e:new Vector,this.max=n!=null?n:new Vector,t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.name="EdgeBounce",t.prototype.apply=function(e,t,n){e.pos.x-e.radius<this.min.x?e.pos.x=this.min.x+e.radius:e.pos.x+e.radius>this.max.x&&(e.pos.x=this.max.x-e.radius);if(e.pos.y-e.radius<this.min.y)return e.pos.y=this.min.y+e.radius;if(e.pos.y+e.radius>this.max.y)return e.pos.y=this.max.y-e.radius},t}(Behaviour),EdgeWrap=function(e){function t(e,n){this.min=e!=null?e:new Vector,this.max=n!=null?n:new Vector,t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.name="EdgeWrap",t.prototype.apply=function(e,t,n){e.pos.x+e.radius<this.min.x?(e.pos.x=this.max.x+e.radius,e.old.pos.x=e.pos.x):e.pos.x-e.radius>this.max.x&&(e.pos.x=this.min.x-e.radius,e.old.pos.x=e.pos.x);if(e.pos.y+e.radius<this.min.y)return e.pos.y=this.max.y+e.radius,e.old.pos.y=e.pos.y;if(e.pos.y-e.radius>this.max.y)return e.pos.y=this.min.y-e.radius,e.old.pos.y=e.pos.y},t}(Behaviour),Wander=function(e){function t(e,n,r){this.jitter=e!=null?e:.5,this.radius=n!=null?n:100,this.strength=r!=null?r:1,this.theta=Math.random()*Math.PI*2,t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.name="Wander",t.prototype.apply=function(e,t,n){return this.theta+=(Math.random()-.5)*this.jitter*Math.PI*2,e.acc.x+=Math.cos(this.theta)*this.radius*this.strength,e.acc.y+=Math.sin(this.theta)*this.radius*this.strength},t}(Behaviour)